{% extends "base.html" %}
{% block title %}My Stats – Stick It In{% endblock %}
{% block content %}
<div class="stats-wrap">
  <h1 class="stats-title">My Stats</h1>

  {% if error_msg %}
    <p class="stats-error">{{ error_msg }}</p>
  {% elif not stats %}
    <p class="stats-empty">No stats available.</p>
  {% else %}

  <!-- OVERVIEW -->
  <section class="stats-section">
    <h2 class="stats-h2">Overview</h2>
    <div class="card-grid">
      <div class="card"><span class="card-label">Total Predictions</span><span class="card-value">{{ stats.totals.predictions|default(0) }}</span></div>
      <div class="card"><span class="card-label">Correct</span><span class="card-value">{{ stats.totals.correct|default(0) }}</span></div>
      <div class="card"><span class="card-label">Accuracy</span><span class="card-value">{{ stats.totals.accuracy_pct|default(0) }}%</span></div>
      <div class="card"><span class="card-label">BTTS</span><span class="card-subvalue">{{ stats.totals.btts_accuracy_pct|default(0) }}% ({{ stats.totals.btts_correct|default(0) }}/{{ stats.totals.btts_predictions|default(0) }})</span></div>
      <div class="card"><span class="card-label">Draws</span><span class="card-subvalue">{{ stats.totals.draw_precision_pct|default(0) }}% ({{ stats.totals.draw_correct|default(0) }}/{{ stats.totals.draw_picks|default(0) }})</span></div>
    </div>
  </section>

  <!-- SELECTION BIAS -->
  <section class="stats-section">
    <h2 class="stats-h2">Selection Bias</h2>
    <div class="table-wrap">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Outcome</th>
            <th>Picked</th>
            <th>Correct</th>
            <th>Hit rate %</th>
          </tr>
        </thead>
        <tbody>
          {% for k in ['Home','Away','Draw'] %}
          <tr>
            <td>{{ k }}</td>
            <td>{{ stats.selection_bias[k].picked|default(0, true) }}</td>
            <td>{{ stats.selection_bias[k].correct|default(0, true) }}</td>
            <td>{{ stats.selection_bias[k].hit_rate_pct|default(0, true) }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- STREAKS -->
  <section class="stats-section">
    <h2 class="stats-h2">Streaks &amp; Recent Form</h2>
    <div class="card-grid card-grid--three">
      <div class="card"><span class="card-label">Longest Win Streak</span><span class="card-value">{{ stats.streaks.longest_win_streak|default(0) }}</span></div>
      <div class="card"><span class="card-label">Longest Loss Streak</span><span class="card-value">{{ stats.streaks.longest_loss_streak|default(0) }}</span></div>
      <div class="card"><span class="card-label">Recent Form</span><span class="card-subvalue">{{ stats.streaks.recent_form.accuracy_pct|default(0) }}% ({{ stats.streaks.recent_form.correct|default(0) }}/{{ stats.streaks.recent_form.played|default(0) }})</span></div>
    </div>
  </section>

  <!-- TEAM HIT RATE -->
  <section class="stats-section">
    <h2 class="stats-h2">Team Hit Rate</h2>

    <form class="controls" method="get" action="{{ url_for('user_stats_view') }}">
      {% if request.args.get('uid') %}
        <input type="hidden" name="uid" value="{{ request.args.get('uid') }}" />
      {% endif %}
      <label>Sort by
        <select name="sort">
          <option value="adj" {% if sort_key=='adj' %}selected{% endif %}>Adjusted Accuracy</option>
          <option value="acc" {% if sort_key=='acc' %}selected{% endif %}>Raw Accuracy</option>
          <option value="attempts" {% if sort_key=='attempts' %}selected{% endif %}>Attempts</option>
        </select>
      </label>
      <label class="ml10">Min Picks
        <select name="min">
          {% for n in [1,3,5,10] %}
            <option value="{{n}}" {% if min_attempts==n %}selected{% endif %}>≥ {{n}}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit" class="btn-go">Apply</button>
    </form>

    <div class="table-wrap">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Team</th>
            <th>Predictions</th>
            <th>Correct</th>
            <th>Accuracy (%)</th>
            <th>Adj (%)</th>
          </tr>
        </thead>
        <tbody>
          {% if teams_sorted %}
            {% for row in teams_sorted %}
            <tr>
              <td>{{ row.team }}</td>
              <td>{{ row.attempts }}</td>
              <td>{{ row.correct }}</td>
              <td>{{ row.accuracy|round(1) }}%</td>
              <td>{{ row.adj_accuracy|round(1) }}%</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="muted">No team history for the current filter.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  {% endif %}
</div>

<style>
  .stats-wrap{max-width:1000px;margin:0 auto;padding:12px}
  .stats-title{margin:18px 0 10px;text-align:center;font-size:2rem;font-weight:800;color:#093759}
  .stats-error{color:#d33;text-align:center}.stats-empty{color:#666;text-align:center}
  .stats-section{margin:20px 0}.stats-h2{font-size:1.25rem;color:#093759;margin:0 0 10px}
  .card-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .card-grid--three{grid-template-columns:repeat(3,1fr)}
  .card{background:#f7f9fb;border:1px solid #e7edf3;border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:84px}
  .card-label{font-weight:600;color:#093759}.card-value{font-size:1.6rem;font-weight:800;color:#093759;margin-top:2px}
  .card-subvalue{font-size:1rem;color:#233f58;margin-top:4px}
  .table-wrap{width:100%;overflow-x:auto;border:1px solid #e7edf3;border-radius:10px;background:#fff}
  .stats-table{width:100%;border-collapse:collapse;min-width:560px}
  .stats-table th,.stats-table td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left}
  .stats-table thead th{background:#093759;color:#fff}
  .stats-table tbody tr:nth-child(odd){background:#f9fbfd}
  .muted{color:#666;text-align:center}
  .controls{display:flex;align-items:center;gap:8px;margin:8px 0 10px}
  .controls select{padding:6px 8px;border:1px solid #d7e1ea;border-radius:8px}
  .btn-go{padding:6px 10px;border:1px solid #093759;background:#093759;color:#fff;border-radius:8px;margin-left:6px}
  .ml10{margin-left:10px}
  @media (max-width:760px){.card-grid{grid-template-columns:repeat(2,1fr)}.card-grid--three{grid-template-columns:1fr}}
  @media (max-width:420px){.card-grid{grid-template-columns:1fr}.stats-title{font-size:1.4rem}}
</style>
{% endblock %}
